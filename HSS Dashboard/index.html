<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>HSS Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
    <div class="header">
        <h1>HSS Dashboard</h1>
        <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
    <div class="container">
        <h2>Security Detections</h2>
        
        <div id="connectionStatus" class="connection-status">
            <div class="status-indicator connected"></div>
            <span>Connected to database</span>
        </div>
        
        <div id="alerts"></div>
        <div id="noAlerts" style="display: none; text-align: center; padding: 20px; color: #666;">
            No detections found. Detections will appear here when detected.
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "apiKey",
            authDomain: "authDomain",
            databaseURL: "databaseURL",
            projectId: "iot-hss-yug",
            storageBucket: "storageBucket",
            messagingSenderId: "messagingSenderId",
            appId: "appId"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showError("Firebase initialization failed: " + error.message);
        }

        const auth = firebase.auth();
        const db = firebase.database();

        // Protect route - redirect to login if not signed in
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                console.log("User authenticated:", user.email);
                // Load detections once user is authenticated
                loadDetections();
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut();
        });

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'background: #ffebee; color: #c62828; padding: 15px; margin: 15px 0; border-radius: 4px;';
            errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
            document.querySelector('.container').appendChild(errorDiv);
        }

        // Load detections from Realtime Database
        function loadDetections() {
            console.log("Loading detections from database...");
            
            // Reference to the detections path
            const detectionsRef = db.ref('detections');
            
            detectionsRef.orderByChild('timestamp').on('value', snapshot => {
                const alertsDiv = document.getElementById('alerts');
                const noAlertsDiv = document.getElementById('noAlerts');
                alertsDiv.innerHTML = '';
                
                if (!snapshot.exists()) {
                    noAlertsDiv.style.display = 'block';
                    console.log("No detections found in database");
                    return;
                }
                
                noAlertsDiv.style.display = 'none';
                const detections = [];
                
                snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    data.id = childSnapshot.key;
                    detections.push(data);
                });
                
                console.log("Detections retrieved:", detections.length);
                
                // Sort by timestamp descending (newest first)
                detections.sort((a, b) => {
                    try {
                        const timeA = new Date(a.timestamp).getTime();
                        const timeB = new Date(b.timestamp).getTime();
                        return timeB - timeA;
                    } catch (e) {
                        return 0;
                    }
                });
                
                // Display detections
                detections.forEach(data => {
                    let timeString = "No timestamp";
                    
                    if (data.timestamp) {
                        try {
                            timeString = new Date(data.timestamp).toLocaleString();
                        } catch (e) {
                            timeString = "Invalid timestamp";
                        }
                    }
                    
                    // Determine alert type based on status
                    let alertClass = "alert-item";
                    if (data.status && data.status.includes("Motion")) {
                        alertClass = "alert-item motion-alert";
                    } else if (data.status && data.status.includes("Breach")) {
                        alertClass = "alert-item breach-alert";
                    }
                    
                    alertsDiv.innerHTML += `
                        <div class="${alertClass}">
                            <strong>${data.zone || "Unknown Zone"}</strong> - ${data.status || "No Status"}
                            <br>
                            <small>Node: ${data.node || "N/A"}</small>
                            <br>
                            <small>${timeString}</small>
                        </div>
                    `;
                });
            }, error => {
                console.error("Error loading detections:", error);
                showError("Failed to load detections: " + error.message);
            });
        }
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
        }
        .header {
            background-color: #2196F3;
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        .logout-btn {
            background-color: #f44336;
            border: none;
            color: white;
            padding: 8px 12px;
            position: absolute;
            right: 20px;
            top: 15px;
            cursor: pointer;
            border-radius: 4px;
        }
        .container {
            background-color: white;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .alert-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
            background-color: #f9f9f9;
        }
        .motion-alert {
            border-left-color: #ff9800;
            background-color: #fff3e0;
        }
        .breach-alert {
            border-left-color: #f44336;
            background-color: #ffebee;
        }
        .connection-status {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: #4caf50;
        }
    </style>
</body>
</html>
